<html>
    <head>
        <title>Almost Darkness</title>
        <script src="classes/Human.js"></script>
        <script src="classes/Room.js"></script>
        <script src="classes/Random.js"></script>
        <script src="classes/Door.js"></script>
        <script src="classes/Dir.js"></script>
        <script src="classes/Fishman.js"></script>
        <script src="classes/Ammobox.js"></script>
        <script src="classes/Point.js"></script>
        <script src="classes/HouseBuilder.js"></script>
        <script src="classes/Mixer.js"></script>
        <script src="classes/RoomEventHandler.js"></script>
        <script src="classes/QuestItem.js"></script>
        <script src="classes/Key.js"></script>
        <script src="classes/RunningShoes.js"></script>
        <script src="classes/Health.js"></script>
        <script src="classes/Table.js"></script>
        <script src="classes/Candle.js"></script>
        <script src="classes/Carpet.js"></script>
        <script src="classes/Lamp.js"></script>
        <style>
        #canvas_container{margin:0 auto 0 auto; width: 1340px}
        body{background: #000}
        #gamecanvas{background:#000; border: 0; float:left; border: 1px solid #f00}
        #statuscanvas{background:#111; border: 0; margin-left: 10px;}
       </style>
    </head>
    <body>
        <div id="canvas_container">
            <canvas id="gamecanvas" width="1140" height="722"></canvas>
            <div style="float:left" >
                <canvas id="statuscanvas" width="140" height="422"></canvas>
                <br/><input type="button" value="no frameskip" onclick="frameskip=1"/>
                <br/><input type="button" value="frameskip" onclick="frameskip=4"/>
            </div>
        </div>
        <script>
            var mixer = new Mixer();
            var gamecanvas = document.getElementById('gamecanvas');
            var gamecanvasC = gamecanvas.getContext('2d');

            var reh = new RoomEventHandler();

            var forceDrawAll = false;
            

            var statuscanvas = document.getElementById('statuscanvas');
            var statuscanvasC = statuscanvas.getContext('2d');
            var img = new Image();
            img.src = "sprite.png";

            var ammo = 12;
            var doors = 0;
            var camera = new Point(0,0);

            var g = 0;
            var g2 = 0;
            var move = 0;

            var frame = 0;

            var frameskip = 1;
            var human;
            function gamelogic()
            {
                frame++;
                if(frame<80){ drawText(13,4,"almost darkness",gamecanvasC); return; }

                if(frame==80)
                {
                    var hb = new HouseBuilder();
                    
                    var roomstart = hb.getStartRoom();
                    currentRoom = roomstart;
                    human = new Human(19,5,roomstart);
                    reh.handleRoom(roomstart,function(x,y){return false;});

                    human.isHuman=true;
                    pieces.push(human);             
                    human.currentRoom=roomstart;
                }


                var updateTile = new Array();

                for(var x=0; x<human.currentRoom.width; x++)
                {
                    for(var y=0; y<human.currentRoom.height; y++)
                    {            
                        var t = human.currentRoom.getTile(x,y);
                        if(t instanceof Object) t.brightness = 22;
                    }
                }


                human.update2();
   

                var dt = new Array();

                    dt.push(human);


                if(true)
                {
                    var pu = updatePieces();
                    dt = dt.concat(pu);                    
                    //drawPieces();
                }
                if(frame%frameskip!=0)return;
                for(var i=0; i<dt.length; i++)
                {
                    var p = dt[i];
                    var c = ( p.getTilePos ? p.getTilePos() : -1);
                        if(c.hurt)c=-1;
                    if(c>-1)
                    {
                        updateTile.push(c);
                        updateTile.push(c-1);
                        updateTile.push(c+1);
                        updateTile.push(c+human.currentRoom.width);
                        updateTile.push(c-human.currentRoom.width);
                        updateTile.push(c+human.currentRoom.width+1);
                        updateTile.push(c-human.currentRoom.width+1);
                        updateTile.push(c+human.currentRoom.width-1);
                        updateTile.push(c-human.currentRoom.width-1);
                    }
                }


                drawRoom(updateTile);

                for(var i=0; i<dt.length; i++)
                {
                    var p = dt[i];
                    drawPiece(p);
//                    gamecanvasC.drawImage(img,x*28,y*38,28,38,p.x2-14-camera.x*28,p.y2-36-camera.y*38,28,38);
                }
    
                if(Math.random()<0.1 )
                {
                    refreshStatus();
                }



            }

            function drawText(x,y,text,canvas)
            {
                var i;
                for(i=0; i<text.length; i++)
                {
                    var imgx = -1;
                    var imgy = -1;
                    if(text[i]=="1"){imgx=1; imgy=2;}
                    if(text[i]=="2"){imgx=2; imgy=2;}
                    if(text[i]=="3"){imgx=3; imgy=2;}
                    if(text[i]=="4"){imgx=4; imgy=2;}
                    if(text[i]=="5"){imgx=0; imgy=3;}
                    if(text[i]=="6"){imgx=1; imgy=3;}
                    if(text[i]=="7"){imgx=2; imgy=3;}
                    if(text[i]=="8"){imgx=3; imgy=3;}
                    if(text[i]=="9"){imgx=4; imgy=3;}
                    if(text[i]=="0"){imgx=0; imgy=2;}
                    if(text[i]=="a"){imgx=1; imgy=8;}
                    if(text[i]=="b"){imgx=2; imgy=8;}
                    if(text[i]=="c"){imgx=3; imgy=8;}
                    if(text[i]=="d"){imgx=4; imgy=8;}
                    if(text[i]=="e"){imgx=5; imgy=8;}
                    if(text[i]=="f"){imgx=6; imgy=8;}
                    if(text[i]=="g"){imgx=7; imgy=8;}
                    if(text[i]=="h"){imgx=8; imgy=8;}
                    if(text[i]=="i"){imgx=7; imgy=7;}
                    if(text[i]=="j"){imgx=8; imgy=7;}
                    if(text[i]=="k"){imgx=7; imgy=6;}
                    if(text[i]=="l"){imgx=8; imgy=6;}
                    if(text[i]=="m"){imgx=7; imgy=5;}
                    if(text[i]=="n"){imgx=8; imgy=5;}
                    if(text[i]=="o"){imgx=7; imgy=4;}
                    if(text[i]=="p"){imgx=8; imgy=4;}
                    if(text[i]=="q"){imgx=7; imgy=3;}
                    if(text[i]=="r"){imgx=8; imgy=3;}
                    if(text[i]=="s"){imgx=7; imgy=2;}
                    if(text[i]=="t"){imgx=8; imgy=2;}

                    if(imgx>-1)canvas.drawImage(img,imgx*28,imgy*38,28,38,x*28,y*38,28,38);
                    x++;
                }
            }
  
            document.addEventListener("keydown",kdh,false);
            document.addEventListener("keyup",kdh2,false);
            var pieces = new Array();

            var random = new Random(1211);

           

            setInterval(gamelogic,14);


            function updatePieces()
            {
                var index;
                var wasUpdated = new Array();
                for(index = 0; index < pieces.length; index++)
                {
                    var p = pieces[index];
                    if(p.currentRoom == human.currentRoom)
                    {
                        if(p!=human) if(p.update){ p.update(); wasUpdated.push(p);}
                    }
                }
                return wasUpdated;
            }
 
            function drawPiece(p)
            {
                   var imgC = p.getImage();
                   var x = imgC.x;
                   var y = imgC.y;
                   var o = imgC.o;
                   var offset = p.offsetImg;
                   gamecanvasC.drawImage(img,x*28,y*38,28,38,p.x2-camera.x*28-offset.x,p.y2-camera.y*38-offset.y,28,38);
                   if(o)
                   {
                      var x = o.x;
                      var y = o.y;
                      gamecanvasC.drawImage(img,x*28,y*38,28,38,p.x2-camera.x*28-offset.x,p.y2-camera.y*38-offset.y,28,38);
                  }
                        x = 3; y = 4;
                        if(getAimed()==p)gamecanvasC.drawImage(img,x*28,y*38,28,38,p.x2-camera.x*28-offset.x,p.y2-camera.y*38-offset.y,28,38);
                        p.hurtAnimation = false;
            }

            function removeRandomFishman()
            {
                mixer.play(1);
                if(Math.random()<0.2)return;
                var f = getAimed();
                if(f)f.getHit();

            }

            function getAimed()
            {
                for(index = 0; index < pieces.length; index++)
                {
                    var p = pieces[index];
                    if(p.currentRoom == human.currentRoom && !p.hurt)
                    {
                        if(p.isFishman){return p;}
                    }
                }
                return false;
            }

            function kdh2(event)
            {
                if(event.keyCode==68) human.releaseAction(68);
                else if(event.keyCode==65) human.releaseAction(65);
                else if(event.keyCode==87) human.releaseAction(87);
                else if(event.keyCode==83) human.releaseAction(83);
            }

            function drawRoom(updateTile)
            {
                gamecanvasC.fillStyle="rgb(0,0,0)";

                //updateTile = false;

                updateTile = false;

                if(!(updateTile instanceof Array))
                {
                    //gamecanvasC.clearRect(0,0,1120,722);
                    updateTile = new Array();
                    for(var i=0; i<human.currentRoom.width*human.currentRoom.height; i++) updateTile.push(i);
                }


                for(var i = 0; i<updateTile.length; i++)
                {
                    var v = updateTile[i];
                    var x = parseInt(v%human.currentRoom.width);
                    var y = parseInt(v/human.currentRoom.width);
                    var tile = human.currentRoom.getTile(x,y);

                    var imgx = 0; var imgy = 0;
                    if(tile.getImage)
                    {
                        var p = tile.getImage();
                        imgx = p.x; imgy = p.y;
                    }
                    else
                    {
                        if(tile==0) { imgx = 1; imgy=0; }
                        else if(tile==1) { imgx = 2; imgy=0; }
                        else if(tile==2) { imgx = 3; imgy = 0; } 
                        else if(tile==4) { imgx = 3; imgy = 1; } 
                        else if(tile==5) { imgx = 4; imgy = 1; } 

                        else if(tile==14) { imgx = 5; imgy = 0; } 
                        else if(tile==15) { imgx = 5; imgy = 1; } 

                        else if(tile==24) { imgx = 5; imgy = 2; } 
                        else if(tile==25) { imgx = 5; imgy = 5; } 

                    }
                    if(tile!=-1)
                    {
                        var alpha = 1-( tile.getDarkness ? tile.getDarkness() : 0 );
                        gamecanvasC.globalAlpha = alpha;
                        if(forceDrawAll || ( tile.skipDraw && !tile.skipDraw() ) )
                        {

                            tile.obrightness = tile.brightness;
                            gamecanvasC.clearRect((x-camera.x)*28,(y-camera.y)*38,28,38);
                            gamecanvasC.drawImage(img,imgx*28,imgy*38,28,38,(x-camera.x)*28,(y-camera.y)*38,28,38);
                        }
                    }
                }
                forceDrawAll = false;
                gamecanvasC.globalAlpha=1;
            }

            function refreshStatus()
            {
                statuscanvasC.clearRect(0,0,140,722);               
                statuscanvasC.drawImage(img,2*28,1*38,28,38,0,0,28,38);
                statuscanvasC.drawImage(img,4*28,0*38,28,38,0,38,28,38);
                drawText(1,0,""+ammo,statuscanvasC);
                drawText(1,1,""+doors,statuscanvasC);

                if(human.runlength==2)statuscanvasC.drawImage(img,6*28,3*38,28,38,0,38*2,28,38);
                if(human.hasKey)statuscanvasC.drawImage(img,6*28,1*38,28,38,0,38*3,28,38);
                statuscanvasC.drawImage(img,6*28,0*38,28,38,0,38*4,28,38);
                drawText(1,4,""+( human.health>0 ? human.health : 0),statuscanvasC);

            }

            function kdh(event)
            {
                if(event.keyCode==68) human.doAction(68);
                else if(event.keyCode==65) human.doAction(65);
                else if(event.keyCode==87) human.doAction(87);
                else if(event.keyCode==83) human.doAction(83);
                else if(event.keyCode==32 && ammo>0 && !human.hurt) { ammo--; removeRandomFishman(); }
            }
            setTimeout( "drawRoom(true)", 500);

        </script>
    </body>
</html>
