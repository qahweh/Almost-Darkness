<html>
    <head>
        <title>Almost Darkness</title>
        <script src="classes/Human.js"></script>
        <script src="classes/Room.js"></script>
        <script src="classes/Random.js"></script>
        <script src="classes/Door.js"></script>
        <script src="classes/Dir.js"></script>
        <script src="classes/Fishman.js"></script>
        <script src="classes/Ammobox.js"></script>
        <script src="classes/Point.js"></script>
        <script src="classes/HouseBuilder.js"></script>
        <style>
        #canvas_container{margin:0 auto 0 auto; width: 1340px}
        body{background: #000}
        #gamecanvas{background:#111; border: 2px solid #ddd; float:left}
        #statuscanvas{background:#111; border: 2px solid #ddd; float:left; margin-left: 10px;}
       </style>
    </head>
    <body>
        <div id="canvas_container">
            <canvas id="gamecanvas" width="1140" height="722"></canvas>
            <canvas id="statuscanvas" width="140" height="722"></canvas>
        </div>
        <script>
            var gamecanvas = document.getElementById('gamecanvas');
            var gamecanvasC = gamecanvas.getContext('2d');

            var statuscanvas = document.getElementById('statuscanvas');
            var statuscanvasC = statuscanvas.getContext('2d');
            var img = new Image();
            img.src = "sprite.png";

            var ammo = 6;
            var doors = 0;

            function drawText(x,y,text)
            {
                var i;
                for(i=0; i<text.length; i++)
                {
                    var imgx = 0;
                    var imgy = 2;
                    if(text[i]=="1"){imgx=1; imgy=2;}
                    if(text[i]=="2"){imgx=2; imgy=2;}
                    if(text[i]=="3"){imgx=3; imgy=2;}
                    if(text[i]=="4"){imgx=4; imgy=2;}
                    if(text[i]=="5"){imgx=0; imgy=3;}
                    if(text[i]=="6"){imgx=1; imgy=3;}
                    if(text[i]=="7"){imgx=2; imgy=3;}
                    if(text[i]=="8"){imgx=3; imgy=3;}
                    if(text[i]=="9"){imgx=4; imgy=3;}
                    if(text[i]=="0"){imgx=0; imgy=2;}
                    if(text[i]=="a"){imgx=0; imgy=0;}
                    statuscanvasC.drawImage(img,imgx*28,imgy*38,28,38,x*28,y*38,28,38);
                    x++;
                }
            }
  
            document.addEventListener("keydown",kdh,false);
 var pieces = new Array();

            var random = new Random(1211);

            var hb = new HouseBuilder();
            
            var human = new Human(12,12,hb.getStartRoom());
            human.isHuman=true;
            pieces.push(human);
                    //   pieces.push( new Fishman(12,8,room) );
//            pieces.push( new Ammobox(12,6,room) );
             
           
            function updatePieces()
            {
                var index;
                
                for(index = 0; index < pieces.length; index++)
                {
                    var p = pieces[index];
                    if(p.currentRoom == human.currentRoom)
                    {
                        if(p!=human)
                        if(p.update)p.update();
                    
                    }
                }

            }
 
            function drawPieces()
            {
                var index;
                for(index = 0; index < pieces.length; index++)
                {
                    var p = pieces[index];
                    if(p.currentRoom == human.currentRoom)
                    {
                        var imgC = p.getImage();
                        var x = imgC.x;
                        var y = imgC.y;
                        var o = imgC.o;
                        gamecanvasC.drawImage(img,x*28,y*38,28,38,p.x*28,p.y*38,28,38);

                        if(o)
                        {
                            var x = o.x;
                            var y = o.y;
                            gamecanvasC.drawImage(img,x*28,y*38,28,38,p.x*28,p.y*38,28,38);
                        }
                        p.hurtAnimation = false;
                    }
                }
            }

            function removeRandomFishman()
            {
                if(Math.random()<0.2)return;
                for(index = 0; index < pieces.length; index++)
                {
                    var p = pieces[index];
                    if(p.currentRoom == human.currentRoom && !p.hurt)
                    {
                        if(p.isFishman){p.getHit(); return;}
                    }
                }
 
            }

            function kdh(event)
            {
                human.update();
                
                for(var x=0; x<human.currentRoom.width; x++)
                {
                    for(var y=0; y<human.currentRoom.height; y++)
                    {
                        var tile = human.currentRoom.getTile(x,y);
                       // if(tile!=-1)alert( tile instanceof Door );

                        var imgx = 0; var imgy = 0;
                        if(tile==0) { imgx = 1; imgy=0; }
                        else if(tile==1) { imgx = 2; imgy=0; }
                        else if(tile==2) { imgx = 3; imgy = 0; } 
                        else if(tile==4) { imgx = 3; imgy = 1; } 
                        else if(tile==5) { imgx = 4; imgy = 1; } 
                        else if(tile instanceof Door) { imgx = 4; imgy = 0; }
                        if(tile!=-1)gamecanvasC.drawImage(img,imgx*28,imgy*38,28,38,x*28,y*38,28,38);
                    }
                }
                if(event!=null)
                {
                
                if(event.keyCode==68) human.moveRight();
                else if(event.keyCode==65) human.moveLeft();
                else if(event.keyCode==87) human.moveUp();
                else if(event.keyCode==83) human.moveDown();
                else if(event.keyCode==32 && ammo>0 && !human.hurt) { ammo--; removeRandomFishman(); }
                updatePieces();

                }

                if(human.currentRoom.getTile(human.x,human.y) instanceof Door)
                {
                    var door = human.currentRoom.getTile(human.x,human.y);

                    doors = doors + door.counter;
                    door.counter =  0;  
                    gamecanvasC.clearRect(0,0,1120,722);
                    room = door.getToRoom(human);
                    //if(!room.isBuild){ room._makeRoomMatrisByRandom(); door.calculateStart(); }
                    
                    
                    human.x = door.startx;
                    human.y = door.starty;
                    human.currentRoom = room;
                    kdh(null);

                    gamecanvasC.drawImage(img,human.imgx*28,human.imgy*38,28,38,human.x*28,human.y*38,28,38);
                    drawPieces();
             }

              // var imgC = human.getImage();
               // gamecanvasC.drawImage(img,imgC.x*28,imgC.y*38,28,38,human.x*28,human.y*38,28,38);
                statuscanvasC.clearRect(0,0,140,722);               
                statuscanvasC.drawImage(img,2*28,1*38,28,38,0,0,28,38);
                statuscanvasC.drawImage(img,4*28,0*38,28,38,0,38,28,38);
                drawText(1,0,""+ammo);
                drawText(1,1,""+doors);
                drawPieces();
             }

        </script>
    </body>
</html>
